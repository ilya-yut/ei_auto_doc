FUNCTION /SKN/F_SW_10_01_ORD_VAL_TOT .
*"----------------------------------------------------------------------
*"*"Local Interface:
*"  EXPORTING
*"     VALUE(IS_ALERT) TYPE  CHAR1
*"  TABLES
*"      T_SELECT STRUCTURE  RSSELECT OPTIONAL
*"      T_DATA STRUCTURE  /SKN/S_SW_10_01_ORD_VAL_TOT OPTIONAL
*"----------------------------------------------------------------------
DATA: LS_DATA_DET TYPE /SKN/S_SW_10_01_ORD_VAL_NEW,
      LT_DATA_DET LIKE TABLE OF LS_DATA_DET.
*FIELD-SYMBOLS <fs_DATA_DET> type /SKN/S_SW_10_01_ORD_VAL_NEW.
DATA: LS_DATA LIKE LINE OF T_DATA.
TYPES: TY_AGGR_PERIOD(8) TYPE N,
       TY_AGGR_ARG TYPE STRING.
DATA: LV_AGGR_PERIOD_VAL TYPE TY_AGGR_PERIOD,
      LV_AGGR_ARG_VAL TYPE TY_AGGR_ARG.
DATA: BEGIN OF LS_DET_AGGR.
  INCLUDE STRUCTURE /SKN/S_SW_10_01_ORD_VAL_NEW.
DATA: AGGR_PERIOD TYPE TY_AGGR_PERIOD,
      AGGR_ARG TYPE TY_AGGR_ARG.
DATA: END OF LS_DET_AGGR.
DATA: LT_DET_AGGR LIKE TABLE OF LS_DET_AGGR.
FIELD-SYMBOLS <FS_DET_AGGR> LIKE LS_DET_AGGR.
DATA: BEGIN OF LS_AGGR,
        AGGR_PERIOD  TYPE TY_AGGR_PERIOD,
        AGGR_ARG     TYPE TY_AGGR_ARG,
        TOT_NETWR	   TYPE NETWR_AK,
        TOT_NETWR_FR TYPE NETWR_AK,
        TOT_CNT      TYPE INT4,
      END OF LS_AGGR.
*data: lt_AGGR like  TABLE OF ls_AGGR.
DATA: LT_AGGR LIKE HASHED TABLE OF LS_AGGR
               WITH UNIQUE KEY AGGR_ARG AGGR_PERIOD.
*FIELD-SYMBOLS <fs_AGGR> like ls_AGGR.
*data: begin of ls_AGGR_key,
*        aggr_period  type ty_aggr_period,
*        aggr_arg     type ty_aggr_arg,
*      end of ls_AGGR_key.
DATA : FLD(60) TYPE C .
DATA : REF_DATE TYPE D.
FIELD-SYMBOLS:  TYPE ANY ,
               <FS_V> TYPE ANY .
DATA : REF_STRING(60) TYPE C.
DATA: BEGIN OF LS_AGGR_FIELDS,
       FIELDNAME TYPE FIELDNAME,
      END OF LS_AGGR_FIELDS.
DATA: LT_AGGR_FIELDS LIKE TABLE OF LS_AGGR_FIELDS.
DATA:  DATE_FROM LIKE SY-DATUM,
       DATE_TO LIKE SY-DATUM,
       DATE_FROM_START_PERIOD LIKE SY-DATUM.
DATA_MULTY: AGGR_FIELDS  NAME_KOMP,
            TOT_NETWR	   NETWR_AK,
            TOT_NETWR_FR NETWR_AK,
            TOT_CNT      INT4,
            DATUM        SY-DATUM,
            STAT         J_STATUS.
DATA_SINGLE: AGGR_PERIOD  CHAR1,  " M - Month/W - Week/Q - Qurter/Y - Year
             DATE_REF_FLD NAME_FELD,
             BACKDAYS     INT4,
             FORWDAYS     INT4.
SELECT_MULTY: DATUM,
              AGGR_FIELDS,
              TOT_NETWR,
              TOT_NETWR_FR,
              TOT_CNT,
              STAT.
 LV_DATE_REF_FLD = 'VDATU'."Delivery Date)
 LV_AGGR_PERIOD = 'M'.
 LV_BACKDAYS = 0.
 SELECT_SINGLE: AGGR_PERIOD,
                DATE_REF_FLD,
                BACKDAYS,
                FORWDAYS.
 IF NOT LV_FORWDAYS  IS INITIAL.
   LV_BACKDAYS = LV_FORWDAYS * ( -1 ).
 ENDIF.
 IF R_DATUM[] IS INITIAL .
   RS_DATUM-SIGN = 'I' .
   RS_DATUM-OPTION = 'GE' .
   DATE_FROM = SY-DATUM - LV_BACKDAYS .
   RS_DATUM-LOW = DATE_FROM .
   APPEND RS_DATUM TO R_DATUM.
 ENDIF.
  "--- Set Reference Date Field
  DATE_FROM = SY-DATUM.
  READ TABLE R_DATUM INTO RS_DATUM INDEX 1.
  IF SY-SUBRC IS INITIAL.
    DATE_FROM = RS_DATUM-LOW.
    DATE_TO = RS_DATUM-HIGH.
    IF DATE_TO < DATE_FROM.
      DATE_TO = DATE_FROM.
    ENDIF.
  ENDIF.
 REFRESH LT_AGGR_FIELDS.
 IF R_AGGR_FIELDS[] IS NOT INITIAL.
   SELECT *
     INTO CORRESPONDING FIELDS OF TABLE LT_AGGR_FIELDS
     FROM DD03L
     WHERE TABNAME = '/SKN/S_SW_10_01_ORD_VAL_TOT'
       AND FIELDNAME IN R_AGGR_FIELDS.
 ENDIF.
 "--- Prepare Dates for Aggregation (Month/...)
  "-- Save Orogina Dates Selection
   DATA_MULTY: DATUM_SRC    SY-DATUM. " To save original Selection
   R_DATUM_SRC[] = R_DATUM[].
  "-- Set full Date Period Interval
    PERFORM CALC_AGGR_PERIOD_START_DATE USING DATE_FROM LV_AGGR_PERIOD
                                        CHANGING DATE_FROM_START_PERIOD.
    READ TABLE R_DATUM INTO RS_DATUM INDEX 1.
    IF SY-SUBRC IS INITIAL.
      RS_DATUM-LOW = DATE_FROM_START_PERIOD.
      MODIFY R_DATUM FROM RS_DATUM INDEX SY-TABIX.
    ENDIF.
    "--- Substitute DATUM condition in T_SELECT
    DELETE T_SELECT WHERE FIELDNM = 'DATUM'.
    LOOP AT R_DATUM INTO RS_DATUM.
      MOVE-CORRESPONDING RS_DATUM TO T_SELECT.
      T_SELECT-FIELDNM = 'DATUM'.
      APPEND T_SELECT.
    ENDLOOP.
 CALL FUNCTION '/SKN/F_SW_10_01_ORD_VAL_NEW'
   IMPORTING
     IS_ALERT       = IS_ALERT
   TABLES
     T_SELECT       = T_SELECT
     T_DATA         = LT_DATA_DET.
  "--- Prepare Aggregation Arguments
  LOOP AT LT_DATA_DET INTO LS_DATA_DET.
    MOVE-CORRESPONDING LS_DATA_DET TO LS_DET_AGGR.
    "--- Fill Aggregation Arguments
     "-- Aggr Period
      CONCATENATE 'ls_DATA_DET-' LV_DATE_REF_FLD INTO FLD .
      ASSIGN (FLD) TO .
      IF  IS NOT ASSIGNED.
        CONTINUE.
      ENDIF.
      REF_DATE =  .
      PERFORM CALCULATE_AGGR_PERIOD_VAL USING REF_DATE LV_AGGR_PERIOD
                                        CHANGING LV_AGGR_PERIOD_VAL.
      LS_DET_AGGR-AGGR_PERIOD = LV_AGGR_PERIOD_VAL.
     "-- Aggr Key
      CLEAR LV_AGGR_ARG_VAL.
      LOOP AT LT_AGGR_FIELDS INTO LS_AGGR_FIELDS.
        CONCATENATE 'ls_DATA_DET-' LS_AGGR_FIELDS-FIELDNAME INTO FLD .
        ASSIGN (FLD) TO .
        IF  IS NOT ASSIGNED.
          CONTINUE.
        ENDIF.
        WRITE  TO REF_STRING.
        CONCATENATE LV_AGGR_ARG_VAL REF_STRING INTO LV_AGGR_ARG_VAL.
      ENDLOOP.
      LS_DET_AGGR-AGGR_ARG = LV_AGGR_ARG_VAL.
    APPEND LS_DET_AGGR TO LT_DET_AGGR.
    MOVE-CORRESPONDING LS_DET_AGGR TO LS_AGGR.
    LS_AGGR-TOT_CNT = 1.
    LS_AGGR-TOT_NETWR = LS_DET_AGGR-NETWR.
    LS_AGGR-TOT_NETWR_FR = LS_DET_AGGR-NETWR_FR.
    COLLECT LS_AGGR INTO LT_AGGR.
  ENDLOOP.
  "--- Total Filtering
  DELETE LT_AGGR WHERE TOT_CNT NOT IN R_TOT_CNT.
  DELETE LT_AGGR WHERE TOT_NETWR NOT IN R_TOT_NETWR.
  DELETE LT_AGGR WHERE TOT_NETWR_FR NOT IN R_TOT_NETWR_FR.
  "--- Fill result Table
  LOOP AT LT_DET_AGGR INTO LS_DET_AGGR.
    "--- Filter for Original Date Selection
     "-- Get Date ref Field
      CONCATENATE 'ls_DET_AGGR-' LV_DATE_REF_FLD INTO FLD .
      ASSIGN (FLD) TO .
      IF  IS NOT ASSIGNED.
        CONTINUE.
      ENDIF.
      REF_DATE =  .
      "-- Filter
      IF REF_DATE NOT IN R_DATUM_SRC.
        CONTINUE.
      ENDIF.
    READ TABLE LT_AGGR INTO LS_AGGR
                       WITH KEY AGGR_PERIOD = LS_DET_AGGR-AGGR_PERIOD
                                AGGR_ARG    = LS_DET_AGGR-AGGR_ARG.
    IF SY-SUBRC IS INITIAL.
      MOVE-CORRESPONDING LS_DET_AGGR TO LS_DATA.
      MOVE-CORRESPONDING LS_AGGR TO LS_DATA.
      APPEND LS_DATA TO T_DATA.
    ENDIF.
  ENDLOOP.
*--- Check Alert Information
 READ TABLE T_DATA INDEX 1.
 CHECK NOT SY-TFILL  IS INITIAL .
 IS_ALERT = 'X' .
ENDFUNCTION.
FUNCTION /SKN/F_SW_10_06_PO_CHNG_LOG .
*"----------------------------------------------------------------------
*"*"Local Interface:
*"  EXPORTING
*"     VALUE(IS_ALERT) TYPE  CHAR1
*"  TABLES
*"      T_SELECT STRUCTURE  RSSELECT
*"      T_DATA STRUCTURE  /SKN/S_SW_10_06_PO_CHNG_LOG
*"----------------------------------------------------------------------
  "-----------------------------------------------
  " 1. Parameters Definition                     "
  "-----------------------------------------------
  DATA_SINGLE: SW_DEST          RFCDEST,
               BACKDAYS         INT4,
               LANGU            LANGU,
               ELIKZ            ELIKZ,
               LOEKZ            ELOEK,
               DATE_REF_FLD     NAME_FELD,
               DURATION_UNIT    /SKN/E_SW_DURATION_UNIT.
  DATA_MULTY: OBJECTCLAS  CDOBJECTCL,
              OBJECTID    EBELN,
              EBELN       EBELN,
              BUKRS       BUKRS,
              BSART       BSART,
              BSTYP       EBSTYP,
              LOEKZ       ELOEK,
              STATU       ESTAK,
              AEDAT       ERDAT,
              ERNAM       ERNAM,
              LIFNR       ELIFN,
              EKORG       EKORG,
              EKGRP       BKGRP,
              WAERS       WAERS,
              MATNR       MATNR,
              WERKS       EWERK,
              MATKL       MATKL,
              KNTTP       KNTTP,
              BWTAR       BWTAR_D,
              BWTTY       BWTTY_D,
              ELIKZ       ELIKZ,
              EREKZ       EREKZ,
              PSTYP       PSTYP,
              FIPOS       FIPOS,
              WEPOS       WEPOS,
              BEDAT       ETBDT,
              EINDT       EINDT,
              BANFN       BANFN,
              BNFPO       BNFPO,
              ESTKZ       ESTKZ,
              VBUND       RASSC,
              UEBTO       UEBTO,
              UEBTK       UEBTK,
              USERNAME    CDUSERNAME,
              VALUE_NEW   CDFLDVALN,
              VALUE_OLD   CDFLDVALO,
              DATUM       SY-DATUM,
              DURATION    /SKN/E_SW_DURATION.
  DATA: LV_FIELDNAME TYPE FIELDNAME,
        LV_SHIFT     TYPE DDLENG,
        LV_LENG      TYPE DDLENG,
        LV_DOMNAME   TYPE DD07V-DOMNAME,
        LV_DOMVALUE  TYPE DD07V-DOMVALUE_L,
        LV_DDTEXT    TYPE DD07V-DDTEXT,
        LV_EBELN     TYPE EBELN,
        LV_EBELP     TYPE EBELP.
  DATA: LT_DATA TYPE TABLE OF /SKN/S_SW_10_06_PO_CHNG_LOG.
  DATA: LS_DATA LIKE LINE OF T_DATA[].
  DATA: TIME_DIFF TYPE INT4.
  DATA: FLD(60) TYPE C.
  DATA: REF_DATE TYPE D.
  DATA: SY_TABIX  LIKE SY-TABIX,
        DATE_FROM LIKE SY-DATUM .
  DATA: LT_DATA_MD TYPE TABLE OF /SKN/S_SW_10_06_MD_CHNG_LOG.
*  DATA: ls_data_md LIKE LINE OF lt_data_md.
  FIELD-SYMBOLS: <FS_DATA>    LIKE LINE OF T_DATA[],
                 <FS_DATA_MD> LIKE LINE OF LT_DATA_MD,
                          TYPE ANY.
  SELECT_SINGLE: SW_DEST,
                 BACKDAYS.
  SELECT_MULTY: OBJECTCLAS,
                OBJECTID,
                USERNAME.
* Configuration Alert
  CALL FUNCTION '/SKN/F_SW_10_06_MD_CHNG_LOG'
    IMPORTING
      IS_ALERT = IS_ALERT
    TABLES
      T_SELECT = T_SELECT
      T_DATA   = LT_DATA_MD.
* Check if found some change in configuration log
  CHECK IS_ALERT EQ 'X'.
  SELECT_SINGLE: LANGU,
                 LOEKZ,
                 ELIKZ,
                 LOEKZ,
                 DATE_REF_FLD,
                 DURATION_UNIT.
  IF LV_BACKDAYS IS INITIAL.
    LV_BACKDAYS = 10.
  ENDIF.
  IF LV_DURATION_UNIT IS INITIAL.
    LV_DURATION_UNIT = 'D'.
  ENDIF.
  LV_ELIKZ = SPACE.
  LV_LOEKZ = SPACE.
*  lv_date_ref_fld  = 'BEDAT'. "PO date
*  lv_wepos         = 'X'.
  SELECT_MULTY: EBELN,
                BUKRS,
                BSART,
                BSTYP,
                LOEKZ,
                STATU,
                AEDAT,
                ERNAM,
                LIFNR,
                EKORG,
                EKGRP,
                WAERS,
                MATNR,
                WERKS,
                MATKL,
                KNTTP,
                BWTAR,
                BWTTY,
                ELIKZ,
                EREKZ,
                PSTYP,
                FIPOS,
                WEPOS,
                BEDAT,
                BANFN,
                BNFPO,
                ESTKZ,
                VBUND,
                UEBTO,
                UEBTK,
                VALUE_NEW,
                VALUE_OLD,
                DATUM,
                DURATION.
  IF R_VALUE_NEW[] IS NOT INITIAL.
    DELETE LT_DATA_MD WHERE VALUE_NEW NOT IN R_VALUE_NEW[].
  ENDIF.
  IF R_VALUE_OLD[] IS NOT INITIAL.
    DELETE LT_DATA_MD WHERE VALUE_OLD NOT IN R_VALUE_OLD[].
  ENDIF.
* Move data change's log to main tab.
  LOOP AT LT_DATA_MD ASSIGNING <FS_DATA_MD>.
    CLEAR: LS_DATA.
    MOVE-CORRESPONDING <FS_DATA_MD> TO LS_DATA.
    LS_DATA-EBELN = <FS_DATA_MD>-KEY2_V.
    LS_DATA-EBELP = <FS_DATA_MD>-KEY3_V.
    APPEND LS_DATA TO T_DATA[].
  ENDLOOP.
* if sw_dest is empty then on premise, else on cloud
  IF LV_SW_DEST IS NOT INITIAL.
    CALL FUNCTION '/SKN/FC_SW_10_06_PO_CHNG_LOG'
      IMPORTING
        IS_ALERT = IS_ALERT
      TABLES
        T_SELECT = T_SELECT
        T_DATA   = T_DATA.
  ENDIF.
  CHECK LV_SW_DEST IS INITIAL.
  IF R_DATUM[] IS INITIAL .
    RS_DATUM-SIGN   = 'I' .
    RS_DATUM-OPTION = 'GE' .
    DATE_FROM       = SY-DATUM - LV_BACKDAYS .
    RS_DATUM-LOW    = DATE_FROM .
    APPEND RS_DATUM TO R_DATUM.
  ENDIF.
  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE LT_DATA
    FROM EKKO AS K INNER JOIN EKPO AS P ON K~EBELN EQ P~EBELN
                   INNER JOIN LFA1 AS L ON K~LIFNR EQ L~LIFNR
    FOR ALL ENTRIES IN T_DATA
    WHERE K~EBELN EQ T_DATA-EBELN
    AND   K~BUKRS IN R_BUKRS[]
    AND   K~BSART IN R_BSART[]
    AND   K~BSTYP IN R_BSTYP[]
    AND   K~LOEKZ IN R_LOEKZ[]
    AND   K~STATU IN R_STATU[]
    AND   K~AEDAT IN R_AEDAT[]
    AND   K~ERNAM IN R_ERNAM[]
    AND   K~LIFNR IN R_LIFNR[]
    AND   K~EKORG IN R_EKORG[]
    AND   K~EKGRP IN R_EKGRP[]
    AND   P~EBELP EQ T_DATA-EBELP
    AND   P~MATNR IN R_MATNR[]
    AND   P~WERKS IN R_WERKS[]
    AND   P~MATKL IN R_MATKL[]
    AND   P~KNTTP IN R_KNTTP[]
    AND   P~BWTAR IN R_BWTAR[]
    AND   P~BWTTY IN R_BWTTY[]
    AND   P~ELIKZ IN R_ELIKZ[]
    AND   P~EREKZ IN R_EREKZ[]
    AND   P~PSTYP IN R_PSTYP[]
    AND   P~FIPOS IN R_FIPOS[]
    AND   P~WEPOS IN R_WEPOS[]
    AND   P~LOEKZ IN R_LOEKZ[]
    AND   P~UEBTO IN R_UEBTO[]
    AND   P~UEBTK IN R_UEBTK[]
    AND   L~VBUND IN R_VBUND[].
*-- Calculate Status Duration (associating to Reference Field (DATE_REF_FLD)
  LOOP AT LT_DATA INTO LS_DATA.
    SY_TABIX = SY-TABIX .
    CONCATENATE 'LS_DATA-' LV_DATE_REF_FLD INTO FLD .
    CHECK FLD IS NOT INITIAL.
    ASSIGN (FLD) TO .
    CHECK  IS ASSIGNED.
    REF_DATE =  .
    IF NOT REF_DATE IS INITIAL.
      LS_DATA-DURATION_UNIT = LV_DURATION_UNIT.
      CALL FUNCTION '/SKN/F_SW_GET_TIME_DIFF'
        EXPORTING
          D_FROM            = REF_DATE
          T_FROM            = SY-UZEIT
          D_TO              = SY-DATUM
          T_TO              = SY-UZEIT
          TIME_UNIT         = LV_DURATION_UNIT   "'D'
        IMPORTING
          TIME_DIFF         = TIME_DIFF
        EXCEPTIONS
          WRONG_VALUE       = 1
          OTHERS            = 2    .
      IF SY-SUBRC = 0.
        IF TIME_DIFF < '999999'.
          LS_DATA-DURATION  = TIME_DIFF .
        ELSE.
          LS_DATA-DURATION  = '999999'.
        ENDIF.
      ENDIF.
      MODIFY LT_DATA FROM LS_DATA INDEX SY_TABIX.
    ENDIF.
  ENDLOOP.
  DELETE LT_DATA WHERE DURATION  NOT IN R_DURATION.
  SORT LT_DATA_MD BY KEY2_V KEY3_V.
  SORT LT_DATA[]  BY EBELN EBELP.
* Customer Description Name
  LOOP AT LT_DATA_MD ASSIGNING <FS_DATA_MD>.
    CLEAR: LS_DATA, LV_EBELN, LV_EBELP.
    LV_EBELN = <FS_DATA_MD>-KEY2_V.
    LV_EBELP = <FS_DATA_MD>-KEY3_V.
    READ TABLE LT_DATA[] ASSIGNING <FS_DATA>
      WITH KEY EBELN = LV_EBELN
               EBELP = LV_EBELP
               BINARY SEARCH.
    IF SY-SUBRC = 0.
      MOVE-CORRESPONDING <FS_DATA> TO LS_DATA.
    ENDIF.
    MOVE-CORRESPONDING <FS_DATA_MD> TO LS_DATA.
    IF LS_DATA-MATKL IS NOT INITIAL.
* Material group desc.
      CALL FUNCTION '/SKN/F_SW_10_MAT_GRP_DESC'
      EXPORTING
        MATKL              = LS_DATA-MATKL
      IMPORTING
        MATKL_DESC         = LS_DATA-WGBEZ
*       MATKL_DESC_L       =
      EXCEPTIONS
        WRONG_CODE         = 1
        OTHERS             = 2
        .
    ENDIF.
*
    IF LS_DATA-BSART IS NOT INITIAL AND LS_DATA-BSTYP IS NOT INITIAL.
*    "-- BSART_DESC
      CALL FUNCTION '/SKN/F_SW_10_BSART_DESC'
      EXPORTING
        BSART            = LS_DATA-BSART
        LANGU            = LV_LANGU
        BSTYP            = LS_DATA-BSTYP
      IMPORTING
        TYPE_DESC        = LS_DATA-BATXT
      EXCEPTIONS
        WRONG_CODE       = 1
        OTHERS           = 2.
    ENDIF.
    IF LS_DATA-STATU IS NOT INITIAL.
      "-- STATU_DESC
      LV_DOMNAME = 'ESTAK'.
      LV_DOMVALUE = LS_DATA-STATU.
      CALL FUNCTION '/SKN/F_SW_GET_DOMAIN_VALUE'
      EXPORTING
        I_DOMNAME        = LV_DOMNAME
        I_DOMVALUE       = LV_DOMVALUE
        LANGU            = LV_LANGU
*       SW_DEST          =
      IMPORTING
        E_DDTEXT         = LV_DDTEXT
      EXCEPTIONS
        NOT_EXIST        = 1
        OTHERS           = 2.
      IF SY-SUBRC = 0.
        LS_DATA-STATU_DESC = LV_DDTEXT.
      ENDIF.
    ENDIF.
*
    IF LS_DATA-BSTYP IS NOT INITIAL.
*    "-- BSTYP_DESC
      LV_DOMNAME = 'EBSTYP'.
      LV_DOMVALUE = <FS_DATA>-BSTYP.
      CALL FUNCTION '/SKN/F_SW_GET_DOMAIN_VALUE'
      EXPORTING
        I_DOMNAME        = LV_DOMNAME
        I_DOMVALUE       = LV_DOMVALUE
        LANGU            = LV_LANGU
*       SW_DEST          =
      IMPORTING
        E_DDTEXT         = LV_DDTEXT
      EXCEPTIONS
        NOT_EXIST        = 1
        OTHERS           = 2.
      IF SY-SUBRC = 0.
        LS_DATA-BSTYP_DESC = LV_DDTEXT.
      ENDIF.
    ENDIF.
*
    IF LS_DATA-LIFNR IS NOT INITIAL.
*    "--- Get  Vendor Decriptions
      CALL FUNCTION '/SKN/F_SW_10_VENDOR_DESC'
      EXPORTING
        LIFNR              = LS_DATA-LIFNR
      IMPORTING
        VENDOR_DESC        = LS_DATA-NAME1
      EXCEPTIONS
        WRONG_VENDOR       = 1
        OTHERS             = 2.
    ENDIF.
*
    IF LS_DATA-EKORG IS NOT INITIAL.
*   "-- EKORG_DESC
      CALL FUNCTION '/SKN/F_SW_10_PUR_ORG_DESC'
      EXPORTING
        EKORG              = LS_DATA-EKORG
      IMPORTING
        PUR_ORG_DESC       = LS_DATA-EKOTX
      EXCEPTIONS
        WRONG_CODE         = 1
        OTHERS             = 2.
    ENDIF.
*
*
    IF LS_DATA-EKGRP IS NOT INITIAL.
*   "-- EKGRP_DESC
      CALL FUNCTION '/SKN/F_SW_10_PUR_GRP_DESC'
      EXPORTING
        EKGRP              = LS_DATA-EKGRP
      IMPORTING
        PUR_GRP_DESC       = LS_DATA-EKNAM
      EXCEPTIONS
        WRONG_CODE         = 1
        OTHERS             = 2.
    ENDIF.
    APPEND LS_DATA TO T_DATA[].
  ENDLOOP.
  READ TABLE T_DATA INTO LS_DATA INDEX 1.
  CHECK SY-TFILL IS NOT INITIAL .
  IS_ALERT = 'X' .
ENDFUNCTION.
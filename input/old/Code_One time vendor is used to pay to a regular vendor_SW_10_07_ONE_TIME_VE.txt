FUNCTION /SKN/F_SW_10_07_ONE_TIME_VEND .
*"----------------------------------------------------------------------
*"*"Local Interface:
*"  EXPORTING
*"     VALUE(IS_ALERT) TYPE  CHAR1
*"  TABLES
*"      T_SELECT STRUCTURE  RSSELECT
*"      T_DATA STRUCTURE  /SKN/S_SW_10_07_ONE_TIME_VEND
*"----------------------------------------------------------------------
  INCLUDE /SKN/PC_SQL_DATA.
  TYPES: BEGIN OF TY_DATA,
* REGUH fields
           LAUFD         TYPE REGUH-LAUFD,
           LAUFI         TYPE REGUH-LAUFI,
           XVORL         TYPE REGUH-XVORL,
           ZBUKR         TYPE REGUH-ZBUKR,
           LIFNR         TYPE REGUH-LIFNR,
           KUNNR         TYPE REGUH-KUNNR,
           EMPFG         TYPE REGUH-EMPFG,
           VBLNR         TYPE REGUH-VBLNR,
           WAERS         TYPE REGUH-WAERS,
           ZBNKS         TYPE REGUH-ZBNKS,
           ZBNKN         TYPE REGUH-ZBNKN,
           ZBNKL         TYPE REGUH-ZBNKL,
           RWBTR         TYPE REGUH-RWBTR,
* LFA1 fields
           PAYEE         TYPE LFA1-LIFNR,
           LAND1_PAYEE   TYPE LFA1-LAND1,
           NAME1_PAYEE   TYPE LFA1-NAME1,
           ERDAT         TYPE LFA1-ERDAT,
           LNRZA         TYPE LFA1-LNRZA,
           LOEVM         TYPE LFA1-LOEVM,
           KTOKK         TYPE LFA1-KTOKK,
           XCPDK         TYPE LFA1-XCPDK,    " One time vendor indic.
           VBUND         TYPE LFA1-VBUND,
           STKZN         TYPE LFA1-STKZN,
           SPRAS         TYPE LFA1-SPRAS,
* LFBK fields
           LIFNR_LFBK    TYPE LFBK-LIFNR,
           BANKS         TYPE LFBK-BANKS,
           BANKL         TYPE LFBK-BANKL,
           BANKN         TYPE LFBK-BANKN,
           KOVON         TYPE LFBK-KOVON,
           KOBIS         TYPE LFBK-KOBIS,
* Additional fields
           DURATION      TYPE /SKN/E_SW_DURATION,
           DURATION_UNIT TYPE /SKN/E_SW_DURATION_UNIT,
         END OF TY_DATA,
         TT_DATA TYPE TABLE OF TY_DATA.
  TYPES: BEGIN OF TY_LFA1,
             LIFNR         TYPE LFA1-LIFNR,
             LAND1         TYPE LFA1-LAND1,
             NAME1         TYPE LFA1-NAME1,
             ERDAT         TYPE LFA1-ERDAT,
             LNRZA         TYPE LFA1-LNRZA,
             LOEVM         TYPE LFA1-LOEVM,
             KTOKK         TYPE LFA1-KTOKK,
             XCPDK         TYPE LFA1-XCPDK,    " One time vendor indic.
             VBUND         TYPE LFA1-VBUND,
             STKZN         TYPE LFA1-STKZN,
             SPRAS         TYPE LFA1-SPRAS,
         END OF TY_LFA1,
         TT_LFA1 TYPE TABLE OF TY_LFA1.
  "-----------------------------------------------
  " 1. Parameters Definition                     "
  "-----------------------------------------------
  DATA_SINGLE: SW_DEST             RFCDEST,
               LANGU               LANGU,
               BACKDAYS            INT4,
               FORWDAYS            INT4,
               XCPDK               XCPDK,
               LOEVM               LOEVM,
               DURATION_UNIT       /SKN/E_SW_DURATION_UNIT,
               DATE_REF_FLD        NAME_FELD,
               CONVERT_KEY         CHAR1.
  DATA_MULTY:   LIFNR             LIFNR,
                BUKRS             DZBUKR,
                LAND1             LAND1_GP,
                LAUFD             LAUFD,
                LAUFI             LAUFI,
                XVORL             XVORL,
                VBUND             RASSC,
                KTOKK             KTOKK,
                STKZN             STKZN,
                LNRZA             LNRZA,
                EMPFG             EMPFG,
                ZBNKS             DZBNKS,
                ZBNKN             DZBNKN,
                ZBNKL             DZBNKL,
                LIFNR_LFBK        LIFNR,
                BANKS             BANKS,
                BANKL             BANKK,
                BANKN             BANKN,
                VALID_FROM        KOVON,
                VALID_TO          KOBIS,
                DURATION          /SKN/E_SW_DURATION,
                DATUM             SYDATUM,
                COUNTER           I.
  DATA: SY_DATLO LIKE SY-DATLO ,
        SY_TIMLO LIKE SY-TIMLO .
  DATA: TIME_DIFF TYPE INT4.
  DATA: FLD(60) TYPE C.
  DATA: REF_DATE TYPE D.
  DATA: SY_TABIX  LIKE SY-TABIX,
        DATE_FROM LIKE SY-DATUM,
        DATE_TO   LIKE SY-DATUM.
  DATA: LV_SHIFT      TYPE DDLENG,
        LV_LENG       TYPE DDLENG,
        LV_DOMNAME    TYPE DD07V-DOMNAME,
        LV_DOMVALUE   TYPE DD07V-DOMVALUE_L,
        LV_DDTEXT     TYPE DD07V-DDTEXT,
        LV_OBJECT     TYPE CDOBJECTV,
        LV_LIFNR      TYPE LIFNR,
        LV_STRUCTURE  TYPE DDOBJNAME,
        LV_INDEX      TYPE I,
        LV_OBJECTCLAS TYPE CDOBJECTCL,
        LV_DOC        TYPE CDCHANGENR,
        LV_COUNT_TMP  TYPE I,
        LV_LINES      TYPE I.
  DATA: LS_DATA  TYPE TY_DATA,
        LS_LFA1  TYPE TY_LFA1,
        LS_LIFNR TYPE /SKN/S_SW_10_LIFNR.
  DATA: LT_DATA  TYPE TT_DATA,
        LT_LFA1  TYPE TT_LFA1,
        LT_LIFNR TYPE TABLE OF /SKN/S_SW_10_LIFNR.
  FIELD-SYMBOLS: <FS_DATA>    LIKE LINE OF T_DATA[],
                          TYPE ANY.
* Set default parameter
  LV_BACKDAYS       = 10.
  LV_FORWDAYS       = 10.
  LV_DURATION_UNIT  = 'D'.
  LV_DATE_REF_FLD   = 'LAUFD'.
  LV_LANGU          = 'E'.
  LV_XCPDK          = 'X'.     " One time vendor
  SELECT_MULTY:  LIFNR,
                 BUKRS,
                 LAND1,
                 LAUFD,
                 VBUND,
                 KTOKK,
                 STKZN,
                 LNRZA,
                 EMPFG,
                 ZBNKS,
                 ZBNKN,
                 ZBNKL,
                 LIFNR_LFBK,
                 BANKS,
                 BANKL,
                 BANKN,
                 VALID_FROM,
                 VALID_TO,
                 COUNTER,
                 DATUM .
  SELECT_SINGLE: SW_DEST,
                 LANGU,
                 BACKDAYS,
                 FORWDAYS,
                 XCPDK,
                 LOEVM,
                 DATE_REF_FLD,
                 CONVERT_KEY,
                 DATE_REF_FLD,
                 DURATION_UNIT.
  "--- Run Cloud Mode -----
  IF LV_SW_DEST IS NOT INITIAL.
    CALL FUNCTION '/SKN/FC_SW_10_07_ONE_TIME_VEND'
      IMPORTING
        IS_ALERT = IS_ALERT
      TABLES
        T_SELECT = T_SELECT
        T_DATA   = T_DATA.
  ENDIF.
  CHECK LV_SW_DEST IS INITIAL.
  "--- Run Cloud Mode -----
  CONVERT_MULTY: LIFNR ALPHA.
  CONVERT_MULTY: LIFNR_LFBK ALPHA.
  _SET_SYS_DATE_TIME LV_SW_DEST SY_DATLO SY_TIMLO.
  " Set default value
  IF R_DATUM[] IS INITIAL .
* Backdays
    RS_DATUM-SIGN   = 'I' .
    RS_DATUM-OPTION = 'BT' .
    DATE_FROM       = SY_DATLO - LV_BACKDAYS.
    RS_DATUM-LOW    = DATE_FROM .
    DATE_TO         = SY_DATLO + LV_FORWDAYS.
    RS_DATUM-HIGH   = DATE_TO .
    APPEND RS_DATUM TO R_DATUM.
  ENDIF .
* Date definition
  CASE LV_DATE_REF_FLD.
    WHEN 'LAUFD'.
      IF R_LAUFD[] IS INITIAL AND R_DATUM[] IS NOT INITIAL.
        R_LAUFD[] = R_DATUM[].
      ENDIF.
*    WHEN 'ERDAT'.
*      IF r_erdat[] IS INITIAL AND r_datum[] IS NOT INITIAL.
*        r_erdat[] = r_datum[].
*      ENDIF.
  ENDCASE.
  SELECT R~LAUFD R~LAUFI R~XVORL R~ZBUKR R~LIFNR
         R~KUNNR R~EMPFG R~VBLNR R~WAERS R~ZBNKS R~ZBNKN R~ZBNKL R~RWBTR
         LF~LIFNR AS LIFNR_LFBK LF~BANKS LF~BANKL LF~BANKN LF~KOVON LF~KOBIS
         L~LIFNR AS PAYEE L~LAND1 AS LAND1_PAYEE L~NAME1 AS NAME1_PAYEE L~ERDAT L~LNRZA L~LOEVM
         L~KTOKK L~XCPDK L~VBUND L~STKZN L~SPRAS
    INTO CORRESPONDING FIELDS OF TABLE LT_DATA
    FROM REGUH AS R INNER JOIN      LFA1  AS L  ON  R~LIFNR  EQ L~LIFNR   " check for One time vendor
                    INNER JOIN      LFBK  AS LF ON  R~ZBNKS  EQ LF~BANKS
                                                AND R~ZBNKN  EQ LF~BANKN
                                                AND R~ZBNKL  EQ LF~BANKL
*                    INNER JOIN      lfa1  AS l2 ON  lf~lifnr EQ l2~lifnr
    WHERE R~LAUFD  IN R_LAUFD[]
    AND   R~LAUFI  IN R_LAUFI[]
    AND   R~XVORL  IN R_XVORL[]
    AND   R~LIFNR  IN R_LIFNR[]
    AND   R~ZBUKR  IN R_BUKRS[]
    AND   R~ZBNKS  IN R_ZBNKS[]
    AND   R~ZBNKN  IN R_ZBNKN[]
    AND   R~ZBNKL  IN R_ZBNKL[]
    AND   LF~LIFNR IN R_LIFNR_LFBK[]
    AND   LF~BANKS IN R_BANKS[]
    AND   LF~BANKN IN R_BANKN[]
    AND   LF~BANKL IN R_BANKL[]
    AND   L~KTOKK  IN R_KTOKK[]
    AND   L~XCPDK  EQ LV_XCPDK             " as One Time Vendor
    AND   L~VBUND  IN R_VBUND[]
    AND   L~STKZN  IN R_STKZN[].
  CHECK LT_DATA IS NOT INITIAL.
  SORT LT_DATA BY LIFNR_LFBK.
*-- Calculate Status Duration (associating to Reference Field (DATE_REF_FLD)
  LOOP AT LT_DATA INTO LS_DATA.
    SY_TABIX = SY-TABIX .
    CONCATENATE 'LS_DATA-' LV_DATE_REF_FLD INTO FLD .
    ASSIGN (FLD) TO .
    CHECK  IS ASSIGNED.
    REF_DATE =  .
    IF NOT REF_DATE IS INITIAL.
      LS_DATA-DURATION_UNIT = LV_DURATION_UNIT.
      CALL FUNCTION '/SKN/F_SW_GET_TIME_DIFF'
        EXPORTING
          D_FROM      = REF_DATE
          T_FROM      = SY-TIMLO
          D_TO        = SY-DATLO
          T_TO        = SY-TIMLO
          TIME_UNIT   = LV_DURATION_UNIT
        IMPORTING
          TIME_DIFF   = TIME_DIFF
        EXCEPTIONS
          WRONG_VALUE = 1
          OTHERS      = 2.
      IF SY-SUBRC = 0.
        IF TIME_DIFF < '999999'.
          LS_DATA-DURATION  = TIME_DIFF .
        ELSE.
          LS_DATA-DURATION  = '999999'.
        ENDIF.
      ENDIF.
      MODIFY LT_DATA FROM LS_DATA INDEX SY_TABIX.
    ENDIF.
  ENDLOOP.
  DELETE LT_DATA WHERE DURATION  NOT IN R_DURATION .
  CHECK LT_DATA IS NOT INITIAL.
  SELECT LIFNR LAND1 NAME1 ERDAT LNRZA LOEVM
         KTOKK XCPDK VBUND STKZN SPRAS
    INTO CORRESPONDING FIELDS OF TABLE LT_LFA1
    FROM LFA1
    FOR ALL ENTRIES IN LT_DATA
    WHERE LIFNR EQ LT_DATA-LIFNR_LFBK.
*    IF ls_data-matkl IS NOT INITIAL.
** Material group desc.
*      CALL FUNCTION '/SKN/F_SW_10_MAT_GRP_DESC'
*      EXPORTING
*        matkl              = ls_data-matkl
*      IMPORTING
*        matkl_desc         = ls_data-wgbez
**       MATKL_DESC_L       =
*      EXCEPTIONS
*        wrong_code         = 1
*        OTHERS             = 2
*        .
*    ENDIF.
**
*    IF ls_data-bsart IS NOT INITIAL AND ls_data-bstyp IS NOT INITIAL.
**    "-- BSART_DESC
*      CALL FUNCTION '/SKN/F_SW_10_BSART_DESC'
*      EXPORTING
*        bsart            = ls_data-bsart
*        langu            = lv_langu
*        bstyp            = ls_data-bstyp
*      IMPORTING
*        type_desc        = ls_data-batxt
*      EXCEPTIONS
*        wrong_code       = 1
*        OTHERS           = 2.
*    ENDIF.
*
*    IF ls_data-statu IS NOT INITIAL.
*      "-- STATU_DESC
*      lv_domname = 'ESTAK'.
*      lv_domvalue = ls_data-statu.
*
*      CALL FUNCTION '/SKN/F_SW_GET_DOMAIN_VALUE'
*      EXPORTING
*        i_domname        = lv_domname
*        i_domvalue       = lv_domvalue
*        langu            = lv_langu
**       SW_DEST          =
*      IMPORTING
*        e_ddtext         = lv_ddtext
*      EXCEPTIONS
*        not_exist        = 1
*        OTHERS           = 2.
*      IF sy-subrc = 0.
*        ls_data-statu_desc = lv_ddtext.
*      ENDIF.
*    ENDIF.
**
*    IF ls_data-bstyp IS NOT INITIAL.
**    "-- BSTYP_DESC
*      lv_domname = 'EBSTYP'.
*      lv_domvalue = <fs_data>-bstyp.
*
*      CALL FUNCTION '/SKN/F_SW_GET_DOMAIN_VALUE'
*      EXPORTING
*        i_domname        = lv_domname
*        i_domvalue       = lv_domvalue
*        langu            = lv_langu
**       SW_DEST          =
*      IMPORTING
*        e_ddtext         = lv_ddtext
*      EXCEPTIONS
*        not_exist        = 1
*        OTHERS           = 2.
*      IF sy-subrc = 0.
*        ls_data-bstyp_desc = lv_ddtext.
*      ENDIF.
*    ENDIF.
**
*    IF ls_data-lifnr IS NOT INITIAL.
**    "--- Get  Vendor Decriptions
*      CALL FUNCTION '/SKN/F_SW_10_VENDOR_DESC'
*      EXPORTING
*        lifnr              = ls_data-lifnr
*      IMPORTING
*        vendor_desc        = ls_data-name1
*      EXCEPTIONS
*        wrong_vendor       = 1
*        OTHERS             = 2.
*
*    ENDIF.
**
*    IF ls_data-ekorg IS NOT INITIAL.
**   "-- EKORG_DESC
*      CALL FUNCTION '/SKN/F_SW_10_PUR_ORG_DESC'
*      EXPORTING
*        ekorg              = ls_data-ekorg
*      IMPORTING
*        pur_org_desc       = ls_data-ekotx
*      EXCEPTIONS
*        wrong_code         = 1
*        OTHERS             = 2.
*
*    ENDIF.
**
**
*    IF ls_data-ekgrp IS NOT INITIAL.
**   "-- EKGRP_DESC
*      CALL FUNCTION '/SKN/F_SW_10_PUR_GRP_DESC'
*      EXPORTING
*        ekgrp              = ls_data-ekgrp
*      IMPORTING
*        pur_grp_desc       = ls_data-eknam
*      EXCEPTIONS
*        wrong_code         = 1
*        OTHERS             = 2.
*    ENDIF.
*    APPEND ls_data TO t_data[].
  SORT LT_LFA1 BY LIFNR.
  LOOP AT LT_DATA INTO LS_DATA.
    CLEAR: T_DATA, LS_LFA1.
    MOVE-CORRESPONDING LS_DATA TO T_DATA.
    READ TABLE LT_LFA1 INTO LS_LFA1 WITH KEY LIFNR = LS_DATA-LIFNR_LFBK
                                             BINARY SEARCH.
    IF SY-SUBRC = 0.
      T_DATA-LAND1_LFBK = LS_LFA1-LAND1.
      T_DATA-NAME1_LFBK = LS_LFA1-NAME1.
    ENDIF.
    IF T_DATA-LAND1_LFBK IS NOT INITIAL.
      CALL FUNCTION '/SKN/FC_SW_10_COUNTRY_DESC'
        EXPORTING
          LAND1      = T_DATA-LAND1
          LANGU      = LV_LANGU
          SW_DEST    = LV_SW_DEST
        IMPORTING
          LANDX      = T_DATA-LANDX_LFBK
*         NATIO      =
*         LANDX50    =
*         NATIO50    =
        EXCEPTIONS
          WRONG_CODE = 1
          OTHERS     = 2.
    ENDIF.
    IF T_DATA-LAND1_PAYEE IS NOT INITIAL.
      CALL FUNCTION '/SKN/FC_SW_10_COUNTRY_DESC'
        EXPORTING
          LAND1      = T_DATA-LAND1_PAYEE
          LANGU      = LV_LANGU
          SW_DEST    = LV_SW_DEST
        IMPORTING
          LANDX      = T_DATA-LANDX_PAYEE
*         NATIO      =
*         LANDX50    =
*         NATIO50    =
        EXCEPTIONS
          WRONG_CODE = 1
          OTHERS     = 2.
    ENDIF.
    IF T_DATA-ZBUKR IS NOT INITIAL.
*    "--- Get  BUKRS Decription
      CALL FUNCTION '/SKN/FC_SW_10_COMP_CODE_DESC'
        EXPORTING
          BUKRS          = T_DATA-ZBUKR  " Company Code
          SW_DEST        = LV_SW_DEST
        IMPORTING
          COMP_CODE_DESC = T_DATA-BUTXT  " Name of Company Code or Company
        EXCEPTIONS
          WRONG_CODE     = 1
          OTHERS         = 2.
    ENDIF.
    IF T_DATA-EKORG IS NOT INITIAL.
*   "-- Purch. Org. Desc.
      CALL FUNCTION '/SKN/FC_SW_10_PUR_ORG_DESC'
        EXPORTING
          EKORG        = T_DATA-EKORG
          SW_DEST      = LV_SW_DEST
        IMPORTING
          PUR_ORG_DESC = T_DATA-EKOTX
        EXCEPTIONS
          WRONG_CODE   = 1
          OTHERS       = 2.
    ENDIF.
    APPEND T_DATA.
  ENDLOOP.
  READ TABLE T_DATA INDEX 1.
  CHECK SY-TFILL IS NOT INITIAL .
  IS_ALERT = 'X' .
ENDFUNCTION.